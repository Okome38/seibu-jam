Okome38/seibu-jam
main

GITHUB

ã“ã®ã‚µã‚¤ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã€ã‚ˆã‚Šãƒ¢ãƒ€ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«ã—ãŸã„ã€‚homeã®Indexã¯æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã€å¤©æ°—äºˆå ±ã€æ²ç¤ºæ¿ã®é †ã«ä¸Šã‹ã‚‰ä¸¦ã¹ãŸã„ã€‚ä¸¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¯ã‚ã¾ã‚Šå¤‰æ›´ã—ãªãã¦ã‚ˆã„ã€‚å¿…è¦ã§ã‚ã‚Œã°å¤‰æ›´ã™ã‚‹ã“ã¨ã€‚å¤‰æ›´ã™ã‚‹ã®ã¯ã‚ãã¾ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã‚ã£ã¦ã€ãã‚Œä»¥å¤–ã¯å¯èƒ½ãªé™ã‚Šå¤‰æ›´ã—ãªã„ã“ã¨ã€‚å¿…è¦ã§ã‚ã‚Œã°ãã®æ—¨è¨€ã£ã¦ã€‚

ç·¨é›†
ã“ã®ã‚µã‚¤ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’ãƒ¢ãƒ€ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´ã—ã€æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã€å¤©æ°—äºˆå ±ã€æ²ç¤ºæ¿ã®é †ã«ä¸¦ã¹ç›´ã—ã¾ã™ã€‚

ä¸»ãªå¤‰æ›´ç‚¹ï¼š

ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆIndex.cshtmlï¼‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆ·æ–°
ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ”¹å–„
ã‚«ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒ€ãƒ³ãªUI
è‰²å½©ã¨ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ã®æ”¹å–„

Modern Home Index View
ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ 






@model List<seibuDatabase.Models.Message>
@{
    ViewData["Title"] = "é’æ­¦jam";
}

<div class="hero-section">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="hero-title">ğŸŒ é’æ­¦jam</h1>
            <p class="hero-subtitle">ç¦äº•é«˜å°‚ å­¦ç”Ÿç”Ÿæ´»ã‚µãƒãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
            <a href="https://www.fukui-nct.ac.jp/wp/wp-content/uploads/2025/04/2faa9754d9a33485215a756bb4c73525-1.pdf" 
               class="btn btn-outline-primary btn-sm" target="_blank">
                ğŸ“… è¡Œäº‹äºˆå®šã‚’ç¢ºèª
            </a>
        </div>
    </div>
</div>

<div class="container">
    <!-- æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card mb-5">
        <div class="card-header-modern">
            <h2 class="section-title">
                <span class="icon">ğŸ›</span>
                å¯®ã®é¢¨å‘‚ æ··é›‘åº¦äºˆæ¸¬
            </h2>
            <p class="section-subtitle">ç¾åœ¨ã®çŠ¶æ³ã«åŸºã¥ã„ãŸäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã§ã™</p>
        </div>
        <div class="chart-container">
            <canvas id="congestionChart"></canvas>
        </div>
    </div>

    <!-- å¤©æ°—äºˆå ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card mb-5">
        <div class="card-header-modern">
            <h2 class="section-title">
                <span class="icon">ğŸŒ¤ï¸</span>
                ä»Šæ—¥ãƒ»æ˜æ—¥ã®å¤©æ°—
            </h2>
            <div id="location" class="weather-source"></div>
        </div>
        
        <div id="weatherForecast" class="weather-forecast-grid">
            <div class="weather-card loading">
                <div class="weather-date">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div class="weather-icon-container">
                    <div class="loading-spinner"></div>
                </div>
                <div class="weather-description">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­</div>
                <div class="weather-temp">
                    <span class="temp-min">-â„ƒ</span>
                    <span class="temp-separator">/</span>
                    <span class="temp-max">-â„ƒ</span>
                </div>
            </div>
        </div>
        
        <div id="currentWeatherText" class="weather-status"></div>
    </div>

    <!-- æ²ç¤ºæ¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card">
        <div class="card-header-modern">
            <h2 class="section-title">
                <span class="icon">ğŸ’¬</span>
                ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ²ç¤ºæ¿
            </h2>
            <p class="section-subtitle">ã¿ã‚“ãªã§æƒ…å ±ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†</p>
        </div>

        <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="post-form-container">
            <form asp-controller="Firebase" asp-action="PostMessage" method="post" class="post-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ãŠåå‰</label>
                        <input type="text" name="name" class="form-control modern-input" 
                               placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã‚‚OK" required maxlength="50">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                    <textarea name="message" class="form-control modern-input" rows="3" 
                              placeholder="ä½•ã‹å…±æœ‰ã—ãŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" required maxlength="500"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-post">
                        <span class="btn-icon">ğŸ“</span>
                        æŠ•ç¨¿ã™ã‚‹
                    </button>
                </div>
            </form>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ -->
        <div class="messages-section">
            <div class="messages-header">
                <h3 class="messages-title">æœ€è¿‘ã®æŠ•ç¨¿</h3>
                <span class="messages-count">
                    @(Model?.Count ?? 0) ä»¶ã®æŠ•ç¨¿
                </span>
            </div>
            
            <div class="messages-container">
                @if (Model != null && Model.Count > 0)
                {
                    @foreach (var msg in Model.OrderByDescending(m => m.timestamp).Take(20))
                    {
                        <div class="message-card">
                            <div class="message-header">
                                <span class="message-author">@msg.name</span>
                                <span class="message-time">@msg.timestamp.ToLocalTime().ToString("MM/dd HH:mm")</span>
                            </div>
                            <div class="message-content">
                                @msg.message
                            </div>
                        </div>
                    }
                    
                    @if (Model.Count > 20)
                    {
                        <div class="more-messages">
                            <p class="text-muted">ä»–ã« @(Model.Count - 20) ä»¶ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã™</p>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’­</div>
                        <p class="empty-text">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p class="empty-subtext">æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* å…¨ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
:root {
    --primary-color: #2563eb;
    --secondary-color: #64748b;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --background-light: #f8fafc;
    --background-white: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --border-light: #e2e8f0;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --radius: 12px;
    --radius-sm: 8px;
}

body {
    background-color: var(--background-light);
    color: var(--text-primary);
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    line-height: 1.6;
}

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.hero-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
    color: white;
    padding: 3rem 0;
    margin: -1rem -15px 2rem -15px;
}

.hero-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.hero-subtitle {
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
    opacity: 0.9;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ */
.section-card {
    background: var(--background-white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    border: 1px solid var(--border-light);
}

.card-header-modern {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-light);
    background: linear-gradient(90deg, #fafafa 0%, #ffffff 100%);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: var(--text-primary);
}

.section-title .icon {
    font-size: 1.25rem;
}

.section-subtitle {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.9rem;
}

/* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
.chart-container {
    padding: 2rem;
    background: var(--background-white);
}

#congestionChart {
    max-width: 100%;
    height: 300px !important;
}

/* å¤©æ°—äºˆå ± */
.weather-source {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.weather-source a {
    color: var(--primary-color);
    text-decoration: none;
}

.weather-forecast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 2rem;
}

.weather-card {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
}

.weather-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.weather-card.loading {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
}

.weather-date {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.weather-icon-container {
    margin: 1rem 0;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.weather-img {
    width: 60px;
    height: 60px;
    object-fit: contain;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-light);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.weather-description {
    font-weight: 500;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.weather-temp {
    font-size: 1.1rem;
    font-weight: 600;
}

.temp-min {
    color: var(--primary-color);
}

.temp-max {
    color: var(--danger-color);
}

.temp-separator {
    color: var(--text-secondary);
    margin: 0 0.25rem;
}

.weather-status {
    padding: 1rem 2rem;
    background: var(--background-light);
    border-top: 1px solid var(--border-light);
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
}

/* æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  */
.post-form-container {
    padding: 2rem;
    background: var(--background-light);
    border-bottom: 1px solid var(--border-light);
}

.post-form {
    max-width: 600px;
    margin: 0 auto;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.modern-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    transition: all 0.2s ease;
    background: var(--background-white);
}

.modern-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-actions {
    text-align: center;
    margin-top: 1.5rem;
}

.btn-post {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: var(--radius-sm);
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-post:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
}

.btn-icon {
    font-size: 1rem;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.messages-section {
    padding: 2rem;
}

.messages-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-light);
}

.messages-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
}

.messages-count {
    background: var(--background-light);
    color: var(--text-secondary);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.messages-container {
    max-height: 600px;
    overflow-y: auto;
}

.message-card {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.message-card:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.message-author {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.9rem;
}

.message-time {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.message-content {
    color: var(--text-primary);
    line-height: 1.5;
    word-wrap: break-word;
}

/* ç©ºã®çŠ¶æ…‹ */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-text {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.empty-subtext {
    font-size: 0.9rem;
    margin: 0;
}

.more-messages {
    text-align: center;
    padding: 1rem;
    border-top: 1px solid var(--border-light);
    margin-top: 1rem;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .hero-title {
        font-size: 2rem;
    }
    
    .hero-subtitle {
        font-size: 1rem;
    }
    
    .section-card {
        margin-left: -15px;
        margin-right: -15px;
        border-radius: 0;
    }
    
    .card-header-modern,
    .chart-container,
    .post-form-container,
    .messages-section {
        padding: 1rem;
    }
    
    .weather-forecast-grid {
        grid-template-columns: 1fr;
        padding: 1rem;
    }
    
    .messages-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: var(--background-light);
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb {
    background: var(--border-light);
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}
</style>

<script>
// å¤©æ°—ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
const weatherCode = {
    100: ["100.svg", "500.svg", "æ™´ã‚Œ"],
    101: ["101.svg", "501.svg", "æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š"],
    102: ["102.svg", "502.svg", "æ™´ã‚Œä¸€æ™‚é›¨"],
    103: ["102.svg", "502.svg", "æ™´ã‚Œæ™‚ã€…é›¨"],
    104: ["104.svg", "504.svg", "æ™´ã‚Œä¸€æ™‚é›ª"],
    105: ["104.svg", "504.svg", "æ™´ã‚Œæ™‚ã€…é›ª"],
    106: ["102.svg", "502.svg", "æ™´ã‚Œä¸€æ™‚é›¨ã‹é›ª"],
    107: ["102.svg", "502.svg", "æ™´ã‚Œæ™‚ã€…é›¨ã‹é›ª"],
    108: ["102.svg", "502.svg", "æ™´ã‚Œä¸€æ™‚é›¨ã‹é›·é›¨"],
    110: ["110.svg", "510.svg", "æ™´ã‚Œå¾Œæ™‚ã€…æ›‡ã‚Š"],
    111: ["110.svg", "510.svg", "æ™´ã‚Œå¾Œæ›‡ã‚Š"],
    112: ["112.svg", "512.svg", "æ™´ã‚Œå¾Œä¸€æ™‚é›¨"],
    113: ["112.svg", "512.svg", "æ™´ã‚Œå¾Œæ™‚ã€…é›¨"],
    114: ["112.svg", "512.svg", "æ™´ã‚Œå¾Œé›¨"],
    115: ["115.svg", "515.svg", "æ™´ã‚Œå¾Œä¸€æ™‚é›ª"],
    116: ["115.svg", "515.svg", "æ™´ã‚Œå¾Œæ™‚ã€…é›ª"],
    117: ["115.svg", "515.svg", "æ™´ã‚Œå¾Œé›ª"],
    118: ["112.svg", "512.svg", "æ™´ã‚Œå¾Œé›¨ã‹é›ª"],
    119: ["112.svg", "512.svg", "æ™´ã‚Œå¾Œé›¨ã‹é›·é›¨"],
    120: ["102.svg", "502.svg", "æ™´ã‚Œæœå¤•ä¸€æ™‚é›¨"],
    200: ["200.svg", "200.svg", "æ›‡ã‚Š"],
    201: ["201.svg", "601.svg", "æ›‡ã‚Šæ™‚ã€…æ™´ã‚Œ"],
    202: ["202.svg", "202.svg", "æ›‡ã‚Šä¸€æ™‚é›¨"],
    203: ["202.svg", "202.svg", "æ›‡ã‚Šæ™‚ã€…é›¨"],
    204: ["204.svg", "204.svg", "æ›‡ã‚Šä¸€æ™‚é›ª"],
    300: ["300.svg", "300.svg", "é›¨"],
    301: ["301.svg", "701.svg", "é›¨æ™‚ã€…æ™´ã‚Œ"],
    302: ["302.svg", "302.svg", "é›¨æ™‚ã€…æ­¢ã‚€"],
    400: ["400.svg", "400.svg", "é›ª"],
    401: ["401.svg", "801.svg", "é›ªæ™‚ã€…æ™´ã‚Œ"],
    402: ["402.svg", "402.svg", "é›ªæ™‚ã€…æ­¢ã‚€"]
};

const dayList = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ··é›‘åº¦ãƒ‡ãƒ¼ã‚¿
const baseCongestion = [
    { time: "17æ™‚", percent: 10 },
    { time: "18æ™‚", percent: 50 },
    { time: "19æ™‚", percent: 70 },
    { time: "20æ™‚", percent: 40 },
    { time: "21æ™‚", percent: 50 },
    { time: "22æ™‚", percent: 30 },
    { time: "23æ™‚", percent: 20 }
];

// æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function createCongestionChart(weatherData = null) {
    let adjustedCongestion = [...baseCongestion];
    
    if (weatherData) {
        const currentDate = new Date(weatherData.date);
        const dayOfWeek = currentDate.getDay();
        
        // é‡‘åœŸæ—¥ã®å ´åˆã¯æ··é›‘åº¦ã‚’ä¸‹ã’ã‚‹
        if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) {
            adjustedCongestion = adjustedCongestion.map(item => ({
                time: item.time,
                percent: Math.round(item.percent * 0.2)
            }));
        } else if (weatherData.telop && weatherData.telop.includes("é›¨")) {
            // é›¨ã®å ´åˆã¯æ—©ã„æ™‚é–“ã«ã‚·ãƒ•ãƒˆ
            for (let i = 2; i > 0; i--) {
                const movePercent = Math.min(20, adjustedCongestion[i].percent);
                adjustedCongestion[i].percent -= movePercent;
                adjustedCongestion[i - 1].percent += movePercent;
            }
        }
    }
    
    const labels = adjustedCongestion.map(item => item.time);
    const data = adjustedCongestion.map(item => item.percent);
    
    const ctx = document.getElementById('congestionChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ··é›‘åº¦ï¼ˆ%ï¼‰',
                    data: data,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgba(37, 99, 235, 1)',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { 
                            stepSize: 25,
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)',
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                elements: {
                    point: {
                        hoverRadius: 8
                    }
                }
            }
        });
    }
}

// å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
async function fetchWeatherData() {
    try {
        const url = "https://www.jma.go.jp/bosai/forecast/data/forecast/180000.json";
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const weather = await response.json();
        
        // åœ°åŸŸåã‚’è¡¨ç¤º
        const locationElement = document.getElementById("location");
        if (locationElement && weather[1]) {
            locationElement.innerHTML = 
                `${weather[1].publishingOffice}: ${weather[1].timeSeries[0].areas[0].area.name} - ` +
                `<a href="https://www.jma.go.jp/bosai/forecast/" target="_blank">æ°—è±¡åºã®ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«ä½œæˆ</a>`;
        }
        
        // å¤©æ°—äºˆå ±ã‚’è¡¨ç¤º
        displayWeatherForecast(weather);
        
        // ç¾åœ¨ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const currentWeatherData = getCurrentWeatherData(weather);
        
        // æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
        createCongestionChart(currentWeatherData);
        
    } catch (error) {
        console.error('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç¾åœ¨ã®æ—¥ä»˜ã§åŸºæœ¬ã®æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
        const currentWeatherText = document.getElementById("currentWeatherText");
        if (currentWeatherText) {
            currentWeatherText.innerHTML = '<span style="color: #ef4444;">âš ï¸ å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åŸºæœ¬ã®æ··é›‘åº¦ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</span>';
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
        const weatherForecast = document.getElementById("weatherForecast");
        if (weatherForecast) {
            weatherForecast.innerHTML = `
                <div class="weather-card">
                    <div class="weather-date">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</div>
                    <div class="weather-icon-container">
                        <span style="font-size: 2rem;">âš ï¸</span>
                    </div>
                    <div class="weather-description">å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>
                    <div class="weather-temp">
                        <span class="temp-min">-â„ƒ</span>
                        <span class="temp-separator">/</span>
                        <span class="temp-max">-â„ƒ</span>
                    </div>
                </div>
            `;
        }
        
        createCongestionChart();
    }
}

// å¤©æ°—äºˆå ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayWeatherForecast(weather) {
    const weatherForecast = document.getElementById("weatherForecast");
    if (!weatherForecast) return;
    
    // æ—¢å­˜ã®å¤©æ°—ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
    weatherForecast.innerHTML = '';
    
    try {
        const weatherCodes = weather[0].timeSeries[0].areas[0].weatherCodes;
        const timeDefines = weather[0].timeSeries[0].timeDefines;
        
        // æ°—æ¸©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        let tempData = null;
        try {
            tempData = weather[0].timeSeries[2];
        } catch (e) {
            console.log('æ°—æ¸©ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', e);
        }
        
        // æœ€åˆã®2æ—¥åˆ†ã‚’è¡¨ç¤º
        for (let i = 0; i < Math.min(2, weatherCodes.length); i++) {
            const temperatures = getTemperatureData(tempData, i);
            const weatherItem = createWeatherItem(weatherCodes[i], timeDefines[i], temperatures);
            weatherForecast.appendChild(weatherItem);
        }
    } catch (error) {
        console.error('å¤©æ°—äºˆå ±ã®è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        weatherForecast.innerHTML = `
            <div class="weather-card">
                <div class="weather-date">ã‚¨ãƒ©ãƒ¼</div>
                <div class="weather-icon-container">
                    <span style="font-size: 2rem;">âŒ</span>
                </div>
                <div class="weather-description">å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ</div>
                <div class="weather-temp">
                    <span class="temp-min">-â„ƒ</span>
                    <span class="temp-separator">/</span>
                    <span class="temp-max">-â„ƒ</span>
                </div>
            </div>
        `;
    }
}

// æ°—æ¸©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getTemperatureData(tempData, dayIndex) {
    if (!tempData || !tempData.areas || !tempData.areas[0]) {
        return { min: "--", max: "--" };
    }
    
    try {
        const area = tempData.areas[0];
        let minTemp = "--";
        let maxTemp = "--";
        
        // æœ€é«˜æ°—æ¸©
        if (area.tempsMax && area.tempsMax[dayIndex] !== null && area.tempsMax[dayIndex] !== undefined) {
            maxTemp = area.tempsMax[dayIndex];
        }
        
        // æœ€ä½æ°—æ¸©
        if (area.tempsMin && area.tempsMin[dayIndex] !== null && area.tempsMin[dayIndex] !== undefined) {
            minTemp = area.tempsMin[dayIndex];
        }
        
        return { min: minTemp, max: maxTemp };
    } catch (error) {
        console.error('æ°—æ¸©ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return { min: "--", max: "--" };
    }
}

// å¤©æ°—ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function createWeatherItem(weatherCodeValue, timeDefine, temperatures = { min: "--", max: "--" }) {
    const weatherItem = document.createElement('div');
    weatherItem.className = 'weather-item';
    
    const dt = new Date(timeDefine);
    const weekdayCount = dt.getDay();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    
    const weatherInfo = weatherCode[weatherCodeValue] || ["", "", "ä¸æ˜"];
    
    weatherItem.innerHTML = `
        <div class="date" style="color: ${weekdayCount === 0 ? 'red' : weekdayCount === 6 ? 'blue' : 'black'}">
            ${month}/${day}(${dayList[weekdayCount]})
        </div>
        <img class="weather-img" src="https://www.jma.go.jp/bosai/forecast/img/${weatherInfo[0]}" alt="${weatherInfo[2]}">
        <div class="weather-telop">${weatherInfo[2]}</div>
        <div><span class="temp-min">${temperatures.min}â„ƒ</span>/<span class="temp-max">${temperatures.max}â„ƒ</span></div>
    `;
    
    return weatherItem;
}

// ç¾åœ¨ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCurrentWeatherData(weather) {
    try {
        const weatherCodes = weather[0].timeSeries[0].areas[0].weatherCodes;
        const timeDefines = weather[0].timeSeries[0].timeDefines;
        
        const currentWeatherData = {
            date: timeDefines[0],
            telop: weatherCode[weatherCodes[0]] ? weatherCode[weatherCodes[0]][2] : "ä¸æ˜",
            tempMin: "--",
            tempMax: "--"
        };
        
        // ç¾åœ¨ã®å¤©æ°—ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
        const currentWeatherText = document.getElementById("currentWeatherText");
        if (currentWeatherText) {
            currentWeatherText.textContent = 
                `ç¾åœ¨ã®å¤©æ°—: ${currentWeatherData.telop} (${new Date(currentWeatherData.date).toLocaleDateString()})`;
        }
        
        return currentWeatherData;
        
    } catch (error) {
        console.error('ç¾åœ¨ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return null;
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
    setTimeout(() => {
        fetchWeatherData();
    }, 100);
});
</script>
