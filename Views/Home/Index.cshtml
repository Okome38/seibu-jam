@model List<seibuDatabase.Models.Message>
@{
    ViewData["Title"] = "é’æ­¦jam";
    var userReactions = ViewBag.UserReactions as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<div class="text-center">
    <h1 class="display-4">é’æ­¦jam</h1>
    <p>ç¦äº•é«˜å°‚è¡Œäº‹äºˆå®š <a href="https://www.fukui-nct.ac.jp/wp/wp-content/uploads/2025/04/2faa9754d9a33485215a756bb4c73525-1.pdf">ã“ã“ã‹ã‚‰è¦‹ã‚‹</a></p>
</div>

<!-- å¤©æ°—äºˆå ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="weather-section">
    <h2>å¤©æ°—äºˆå ±</h2>
    <div id="weatherForecast" class="weather-forecast">
        <div class="weather-item">
            <div class="date">èª­ã¿è¾¼ã¿ä¸­...</div>
            <img class="weather-img" alt="å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³">
            <div class="weather-telop">--</div>
            <div><span class="temp-min">-â„ƒ</span>/<span class="temp-max">-â„ƒ</span></div>
        </div>
    </div>
    <div id="location">
        <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank">æ°—è±¡åºã®ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«ä½œæˆ</a>
    </div>
    <div id="currentWeatherText"></div>
</div>

<!-- æ··é›‘åº¦ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="congestion-section">
    <h2>å¯®ã®é¢¨å‘‚ æ··é›‘åº¦ï¼ˆäºˆæ¸¬ï¼‰</h2>
    <canvas id="congestionChart" width="400" height="200"></canvas>
</div>

<!-- æ²ç¤ºæ¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="bulletin-section">
    <h1>æ²ç¤ºæ¿</h1>

    <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form asp-controller="Firebase" asp-action="PostMessage" method="post">
        <div class="form-group">
            <label>åå‰:</label>
            <input type="text" name="name" class="form-control" required />
        </div>
        <div class="form-group">
            <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label>
            <textarea name="message" class="form-control" rows="4" required></textarea>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">æŠ•ç¨¿</button>
        </div>
    </form>

    <hr />

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§è¡¨ç¤º -->
    <h2>æŠ•ç¨¿ä¸€è¦§</h2>
    @if (Model != null && Model.Count > 0)
{
    <div class="message-list">
        @foreach (var msg in Model.OrderByDescending(m => m.timestamp))
        {
            var messageId = msg.id; // Firebaseã®ã‚­ãƒ¼IDã‚’ä½¿ç”¨
            var userReaction = userReactions.ContainsKey(messageId) ? userReactions[messageId] : "";
            
            <div class="message-item card mb-3" data-message-id="@messageId">
                <div class="card-body">
                    <div class="message-header d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="message-author">@msg.name</strong>
                            <small class="text-muted">ï¼ˆ@msg.timestamp.ToString("yyyy/MM/dd HH:mm")ï¼‰</small>
                        </div>
                    </div>
                    <div class="message-content mt-2">
                        @msg.message
                    </div>
                    <div class="message-reactions mt-3 d-flex align-items-center gap-2">
                        <button class="btn btn-sm reaction-btn like-btn @(userReaction == "like" ? "btn-success" : "btn-outline-success")" 
                                data-message-id="@messageId" data-is-like="true">
                            ğŸ‘ <span class="like-count">@msg.likeCount</span>
                        </button>
                        <button class="btn btn-sm reaction-btn dislike-btn @(userReaction == "dislike" ? "btn-danger" : "btn-outline-danger")" 
                                data-message-id="@messageId" data-is-like="false">
                            ğŸ‘ <span class="dislike-count">@msg.dislikeCount</span>
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <p>æŠ•ç¨¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
}
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ã„ã„ã­/ã‚ˆããªã„ã­æ©Ÿèƒ½ã®JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.reaction-btn').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const messageId = this.getAttribute('data-message-id');
            const isLike = this.getAttribute('data-is-like') === 'true';
            
            try {
                const response = await fetch('@Url.Action("AddReaction", "Firebase")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `messageId=${encodeURIComponent(messageId)}&isLike=${isLike}`
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                        window.location.reload();
                    }
                }
            } catch (error) {
                console.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        });
    });
});
</script>

<style>
.message-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: box-shadow 0.2s ease;
}

.message-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-author {
    color: #495057;
    font-size: 1.1em;
}

.message-content {
    font-size: 1em;
    line-height: 1.5;
    color: #212529;
}

.message-reactions {
    border-top: 1px solid #e9ecef;
    padding-top: 10px;
}

.reaction-btn {
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.9em;
    transition: all 0.2s ease;
    cursor: pointer;
}

.reaction-btn:hover {
    transform: translateY(-1px);
}

.reaction-btn.btn-success, .reaction-btn.btn-danger {
    color: white;
}

.like-count, .dislike-count {
    font-weight: bold;
}

.bulletin-section {
    margin-top: 2rem;
}

.weather-section, .congestion-section {
    margin-bottom: 2rem;
}

.gap-2 {
    gap: 0.5rem !important;
}
</style>
